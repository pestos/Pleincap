---
phase: 03-migration-seo
plan: 05
type: execute
wave: 5
depends_on: ["03-04"]
files_modified:
  - src/app/sitemap.ts
  - src/app/robots.ts
  - src/app/(frontend)/catalogue/[slug]/page.tsx
  - src/app/(frontend)/nos-bateaux/[slug]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Dynamic sitemap.xml includes all published cruises, destinations, boats, and posts"
    - "robots.txt blocks /admin/ and /api/ from crawlers"
    - "All dynamic pages have generateMetadata returning correct title, description, and OpenGraph data"
    - "No existing URL returns 404"
    - "Build succeeds with all pages rendering from CMS data"
  artifacts:
    - path: "src/app/(frontend)/sitemap.ts"
      provides: "Dynamic sitemap generated from all published CMS content"
    - path: "src/app/(frontend)/robots.ts"
      provides: "Robots.txt configuration blocking admin and API routes"
  key_links:
    - from: "src/app/(frontend)/sitemap.ts"
      to: "payload.find"
      via: "Queries all published collections"
      pattern: "payload\\.find.*collection"
    - from: "src/app/(frontend)/catalogue/[slug]/page.tsx"
      to: "generateMetadata"
      via: "SEO metadata from CMS"
      pattern: "generateMetadata"
---

<objective>
Implement SEO infrastructure (dynamic sitemap, robots.txt, generateMetadata) and verify the complete migration.

Purpose: Preserve and enhance SEO rankings during the migration. Every dynamic page needs proper metadata, the sitemap must include all published CMS content, and robots.txt must protect admin routes from indexing. This plan completes Phase 3 with a comprehensive verification checkpoint.

Output: Dynamic sitemap.ts, robots.ts, generateMetadata on all dynamic pages. Full migration verified.
</objective>

<execution_context>
@/Users/fredericgueirard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fredericgueirard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-migration-seo/03-RESEARCH.md
@.planning/phases/03-migration-seo/03-04-SUMMARY.md
@src/lib/payload-queries.ts
@src/app/(frontend)/catalogue/[slug]/page.tsx
@src/app/(frontend)/nos-bateaux/[slug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement dynamic sitemap, robots.txt, and generateMetadata</name>
  <files>
    src/app/(frontend)/sitemap.ts
    src/app/(frontend)/robots.ts
    src/app/(frontend)/catalogue/[slug]/page.tsx
    src/app/(frontend)/nos-bateaux/[slug]/page.tsx
  </files>
  <action>
**Dynamic Sitemap (`sitemap.ts`):**
Create `src/app/(frontend)/sitemap.ts` (or at app root level - check if the route group affects sitemap placement; it should be at `src/app/sitemap.ts` if the route group is `(frontend)`). Actually, Next.js sitemap.ts should be at the app root to be accessible at `/sitemap.xml`. Place it at `src/app/sitemap.ts`.

Wait - the app directory has route groups: `(frontend)` and `(payload)`. The sitemap should be at `src/app/sitemap.ts` (outside route groups) so it's accessible at the root.

```typescript
import type { MetadataRoute } from 'next'
import { getPayload } from 'payload'
import config from '@payload-config'

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const payload = await getPayload({ config })
  const baseUrl = 'https://plein-cap.com'

  // Static pages
  const staticPages: MetadataRoute.Sitemap = [
    { url: baseUrl, lastModified: new Date(), changeFrequency: 'weekly', priority: 1.0 },
    { url: `${baseUrl}/catalogue`, lastModified: new Date(), changeFrequency: 'daily', priority: 0.9 },
    { url: `${baseUrl}/destinations`, lastModified: new Date(), changeFrequency: 'weekly', priority: 0.8 },
    { url: `${baseUrl}/nos-bateaux`, lastModified: new Date(), changeFrequency: 'monthly', priority: 0.7 },
    { url: `${baseUrl}/nos-conferenciers`, lastModified: new Date(), changeFrequency: 'monthly', priority: 0.6 },
    { url: `${baseUrl}/equipe`, lastModified: new Date(), changeFrequency: 'monthly', priority: 0.5 },
    { url: `${baseUrl}/blog`, lastModified: new Date(), changeFrequency: 'daily', priority: 0.8 },
    { url: `${baseUrl}/livre-d-or`, lastModified: new Date(), changeFrequency: 'weekly', priority: 0.5 },
    { url: `${baseUrl}/contact`, lastModified: new Date(), changeFrequency: 'yearly', priority: 0.4 },
    // Other static pages
    { url: `${baseUrl}/orient-express`, lastModified: new Date(), changeFrequency: 'monthly', priority: 0.6 },
    { url: `${baseUrl}/escapades-culturelles`, lastModified: new Date(), changeFrequency: 'monthly', priority: 0.6 },
    { url: `${baseUrl}/voyages-en-train`, lastModified: new Date(), changeFrequency: 'monthly', priority: 0.6 },
    { url: `${baseUrl}/notre-histoire`, lastModified: new Date(), changeFrequency: 'yearly', priority: 0.4 },
    { url: `${baseUrl}/special-groupes`, lastModified: new Date(), changeFrequency: 'yearly', priority: 0.4 },
    { url: `${baseUrl}/visioconference`, lastModified: new Date(), changeFrequency: 'monthly', priority: 0.5 },
  ]

  // Dynamic: Published cruises
  const { docs: cruises } = await payload.find({
    collection: 'cruises',
    where: { _status: { equals: 'published' } },
    select: { slug: true, updatedAt: true },
    pagination: false,
  })
  const cruisePages = cruises.map((cruise) => ({
    url: `${baseUrl}/catalogue/${cruise.slug}`,
    lastModified: new Date(cruise.updatedAt),
    changeFrequency: 'weekly' as const,
    priority: 0.8,
  }))

  // Dynamic: Boats
  const { docs: boats } = await payload.find({
    collection: 'boats',
    select: { slug: true, updatedAt: true },
    pagination: false,
  })
  const boatPages = boats.map((boat) => ({
    url: `${baseUrl}/nos-bateaux/${boat.slug}`,
    lastModified: new Date(boat.updatedAt),
    changeFrequency: 'monthly' as const,
    priority: 0.6,
  }))

  // Dynamic: Published posts
  const { docs: posts } = await payload.find({
    collection: 'posts',
    where: { _status: { equals: 'published' } },
    select: { slug: true, updatedAt: true },
    pagination: false,
  })
  const postPages = posts.map((post) => ({
    url: `${baseUrl}/blog/${post.slug}`,
    lastModified: new Date(post.updatedAt),
    changeFrequency: 'weekly' as const,
    priority: 0.7,
  }))

  return [...staticPages, ...cruisePages, ...boatPages, ...postPages]
}
```

**Robots.txt (`robots.ts`):**
Create at `src/app/robots.ts`:
```typescript
import type { MetadataRoute } from 'next'

export default function robots(): MetadataRoute.Robots {
  return {
    rules: [
      {
        userAgent: '*',
        allow: '/',
        disallow: ['/admin/', '/api/'],
      },
    ],
    sitemap: 'https://plein-cap.com/sitemap.xml',
  }
}
```

**generateMetadata on dynamic routes:**

Update `catalogue/[slug]/page.tsx` to add/verify `generateMetadata`:
```typescript
import type { Metadata } from 'next'

export async function generateMetadata({ params }: { params: Promise<{ slug: string }> }): Promise<Metadata> {
  const { slug } = await params
  const cruise = await getCruiseBySlug(slug)
  if (!cruise) return { title: 'Cruise Not Found | PleinCap' }

  return {
    title: cruise.meta?.title || `${cruise.title} | PleinCap Croisieres`,
    description: cruise.meta?.description || cruise.excerpt,
    openGraph: {
      title: cruise.meta?.title || cruise.title,
      description: cruise.meta?.description || cruise.excerpt,
      images: cruise.meta?.image?.url ? [cruise.meta.image.url] : cruise.featuredImage?.url ? [cruise.featuredImage.url] : [],
    },
  }
}
```

Update `nos-bateaux/[slug]/page.tsx` similarly with boat metadata.

**Note on params in Next.js 16:** In Next.js 15+, `params` is a Promise. Use `const { slug } = await params` in both `generateMetadata` and the page component.

**Update sitemap.ts and robots.ts file paths:** Since sitemap and robots need to be at the root app level (not inside a route group), place them at `src/app/sitemap.ts` and `src/app/robots.ts`. Verify this is outside the `(frontend)` and `(payload)` route groups.
  </action>
  <verify>
1. Visit http://localhost:3000/sitemap.xml - should return XML with all static and dynamic URLs
2. Visit http://localhost:3000/robots.txt - should show allow/disallow rules
3. View source of http://localhost:3000/catalogue/danube-imperial - check for correct title and meta description tags
4. View source of a boat detail page - check for correct title and meta description tags
5. Run `npx next build` - should succeed with no errors
  </verify>
  <done>
Dynamic sitemap includes all published CMS content. Robots.txt blocks /admin/ and /api/. All dynamic pages have generateMetadata with SEO-friendly titles and descriptions.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Full migration verification</name>
  <files>None (verification only)</files>
  <action>
Human verification of the complete Phase 3 migration. All CMS-backed pages should fetch data from Payload CMS, seed scripts should have populated the database, and SEO infrastructure (sitemap, robots, metadata) should be in place.

Start the dev server and verify each page renders correctly with CMS data:
1. Homepage (/) - Selection and Testimonials sections from CMS
2. Catalogue (/catalogue) - cruises from CMS
3. Cruise Detail (/catalogue/danube-imperial) - itinerary and experts from CMS
4. Destinations (/destinations) - destination cards from CMS
5. Boats (/nos-bateaux) - boat listing from CMS
6. Boat Detail (/nos-bateaux/amadeus-diamond) - boat specs from CMS
7. Boat Detail (/nos-bateaux/nile-excellence) - boat specs from CMS
8. Speakers (/nos-conferenciers) - 6 speakers from CMS
9. Team (/equipe) - 7 team members from CMS
10. Testimonials (/livre-d-or) - 6 testimonials from CMS
11. Blog (/blog) - posts from CMS or empty state
12. SEO - /sitemap.xml lists all URLs, /robots.txt blocks /admin/
13. No 404s on any existing URL
14. Admin Panel (/admin) - all seeded data visible in collections
  </action>
  <verify>Human visually confirms all 14 items above render correctly.</verify>
  <done>All pages verified rendering CMS content correctly. No 404s. SEO infrastructure working. Phase 3 migration complete.</done>
</task>

</tasks>

<verification>
1. /sitemap.xml returns valid XML with all URLs
2. /robots.txt blocks /admin/ and /api/
3. All dynamic pages have correct title and description in HTML head
4. No 404 on any existing URL
5. Build succeeds
6. Human verifies all pages render correctly
</verification>

<success_criteria>
- Dynamic sitemap generated from CMS content
- Robots.txt protects admin routes
- All dynamic pages have SEO metadata
- Complete migration verified by human
- Build succeeds
- Phase 3 requirements MIGR-01, MIGR-02, MIGR-03 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-migration-seo/03-05-SUMMARY.md`
</output>
