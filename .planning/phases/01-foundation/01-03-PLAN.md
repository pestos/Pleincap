---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - payload.config.ts
  - src/payload/collections/Users.ts
  - src/payload/collections/Media.ts
  - src/payload/seed.ts
autonomous: false

must_haves:
  truths:
    - "Admin can log into /admin with email and password"
    - "Admin can create editor accounts with restricted permissions"
    - "Editor can upload images to media library and see them in backoffice"
    - "Existing frontend pages remain unchanged and functional"
  artifacts:
    - path: "src/payload/collections/Users.ts"
      provides: "Users collection with admin/editor roles and RBAC"
      contains: "CollectionConfig"
      exports: ["Users"]
      min_lines: 30
    - path: "src/payload/collections/Media.ts"
      provides: "Media collection with image upload and auto-resize"
      contains: "upload"
      exports: ["Media"]
      min_lines: 20
    - path: "src/payload/seed.ts"
      provides: "Seed script to create first admin user"
      contains: "payload.create"
      min_lines: 15
    - path: "payload.config.ts"
      provides: "Payload config with Users and Media collections registered"
      contains: "collections.*Users.*Media"
  key_links:
    - from: "payload.config.ts"
      to: "src/payload/collections/Users.ts"
      via: "import and register in collections array"
      pattern: "import.*Users.*from.*collections/Users"
    - from: "payload.config.ts"
      to: "src/payload/collections/Media.ts"
      via: "import and register in collections array"
      pattern: "import.*Media.*from.*collections/Media"
    - from: "src/payload/collections/Users.ts"
      to: "src/app/(payload)/admin/[[...segments]]/page.tsx"
      via: "Payload admin panel uses Users collection for auth"
      pattern: "admin.*user.*users"
    - from: "src/payload/collections/Media.ts"
      to: "public/media/"
      via: "Upload staticDir configuration"
      pattern: "staticDir.*public/media"
---

<objective>
Create the Users and Media collections for Payload CMS, register them in the config, create a seed script for the first admin user, then verify the complete Phase 1 setup works end-to-end.

Purpose: This plan delivers the actual phase success criteria: admin login, user management with roles, and media uploads. The Users collection provides authentication (CMS-01) and RBAC (CMS-02). The Media collection provides image upload and management (CMS-03).

Output: Working /admin panel with login, user management, and media library.
</objective>

<execution_context>
@/Users/fredericgueirard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fredericgueirard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@payload.config.ts
@src/app/(payload)/admin/[[...segments]]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Users and Media collections with RBAC</name>
  <files>src/payload/collections/Users.ts, src/payload/collections/Media.ts, payload.config.ts</files>
  <action>
1. **Create `src/payload/collections/Users.ts`:**
   ```typescript
   import type { CollectionConfig } from 'payload'

   export const Users: CollectionConfig = {
     slug: 'users',
     auth: true,
     admin: {
       useAsTitle: 'email',
       group: 'Administration',
     },
     fields: [
       {
         name: 'name',
         type: 'text',
         required: true,
       },
       {
         name: 'role',
         type: 'select',
         required: true,
         defaultValue: 'editor',
         options: [
           { label: 'Admin', value: 'admin' },
           { label: 'Ã‰diteur', value: 'editor' },
         ],
         access: {
           // Only admins can change roles
           update: ({ req: { user } }) => user?.role === 'admin',
         },
       },
     ],
     access: {
       // Only admins can create users
       create: ({ req: { user } }) => user?.role === 'admin',
       // Users can read their own data, admins can read all
       read: ({ req: { user } }) => {
         if (user?.role === 'admin') return true
         if (user) return { id: { equals: user.id } }
         return false
       },
       // Users can update their own profile (but not role - field-level above), admins can update all
       update: ({ req: { user } }) => {
         if (user?.role === 'admin') return true
         if (user) return { id: { equals: user.id } }
         return false
       },
       // Only admins can delete users
       delete: ({ req: { user } }) => user?.role === 'admin',
       // Admin panel access: both admins and editors can log in
       admin: ({ req: { user } }) => !!user,
     },
   }
   ```

   **Key RBAC decisions:**
   - `auth: true` enables Payload's built-in authentication (login, password hashing, JWT)
   - Admin role: full access to everything
   - Editor role: can log into admin panel, can read/update own profile, cannot create/delete users, cannot change roles
   - Field-level access on `role` field prevents editors from escalating their own privileges

2. **Create `src/payload/collections/Media.ts`:**
   ```typescript
   import type { CollectionConfig } from 'payload'

   export const Media: CollectionConfig = {
     slug: 'media',
     admin: {
       group: 'Contenu',
     },
     upload: {
       staticDir: 'public/media',
       mimeTypes: ['image/*'],
       imageSizes: [
         {
           name: 'thumbnail',
           width: 400,
           height: 300,
           position: 'centre',
         },
         {
           name: 'card',
           width: 768,
           height: 512,
           position: 'centre',
         },
         {
           name: 'hero',
           width: 1920,
           height: undefined,
           position: 'centre',
         },
       ],
     },
     fields: [
       {
         name: 'alt',
         type: 'text',
         required: true,
         label: 'Texte alternatif',
       },
     ],
     access: {
       // Any authenticated user can upload
       create: ({ req: { user } }) => !!user,
       // Public read (images are public assets)
       read: () => true,
       // Any authenticated user can update media metadata
       update: ({ req: { user } }) => !!user,
       // Only admins can delete media
       delete: ({ req: { user } }) => user?.role === 'admin',
     },
   }
   ```

   **Key media decisions:**
   - `staticDir: 'public/media'` stores uploads in public/ for direct URL access (Phase 1 only; production may use S3)
   - Three image sizes: thumbnail (400x300 for lists), card (768x512 for cards), hero (1920xauto for banners)
   - `mimeTypes: ['image/*']` restricts to images only
   - `alt` field is required for accessibility
   - Public read access (images served publicly), authenticated write, admin-only delete

3. **Update `payload.config.ts`** to register both collections:
   Add imports at top:
   ```typescript
   import { Users } from './src/payload/collections/Users'
   import { Media } from './src/payload/collections/Media'
   ```

   Update collections array:
   ```typescript
   collections: [Users, Media],
   ```

4. **Create `src/payload/seed.ts`:**
   ```typescript
   import type { Payload } from 'payload'

   export const seed = async (payload: Payload): Promise<void> => {
     const existingAdmin = await payload.find({
       collection: 'users',
       where: {
         email: {
           equals: 'admin@pleincap.com',
         },
       },
     })

     if (existingAdmin.docs.length === 0) {
       await payload.create({
         collection: 'users',
         data: {
           email: 'admin@pleincap.com',
           password: process.env.ADMIN_PASSWORD || 'Admin123!',
           name: 'Admin PleinCap',
           role: 'admin',
         },
       })
       payload.logger.info('Admin user created: admin@pleincap.com')
     } else {
       payload.logger.info('Admin user already exists, skipping seed')
     }
   }
   ```

5. **Wire the seed function into payload.config.ts.** Add to the buildConfig:
   ```typescript
   onInit: async (payload) => {
     const existingUsers = await payload.find({
       collection: 'users',
       limit: 1,
     })
     if (existingUsers.totalDocs === 0) {
       const { seed } = await import('./src/payload/seed')
       await seed(payload)
     }
   },
   ```
   This runs the seed ONLY when no users exist (first startup). Once an admin is created, it never runs again.

6. **Ensure `public/media/` directory exists:**
   ```bash
   mkdir -p public/media
   ```
   Add a `.gitkeep` file in it to track the directory in git:
   ```bash
   touch public/media/.gitkeep
   ```

7. **Start Docker PostgreSQL, then test:**
   ```bash
   docker-compose up -d
   npm run dev
   ```
   On first startup, Payload will:
   - Auto-create database tables (push mode in dev)
   - Run the onInit hook which seeds the admin user
   - The admin panel should be accessible at http://localhost:3000/admin
  </action>
  <verify>
    - `ls src/payload/collections/Users.ts` confirms Users collection exists
    - `ls src/payload/collections/Media.ts` confirms Media collection exists
    - `ls src/payload/seed.ts` confirms seed script exists
    - `cat payload.config.ts` shows Users and Media in collections array
    - `cat payload.config.ts` shows onInit hook
    - `docker-compose ps` shows PostgreSQL running
    - `npm run build` succeeds
    - Dev server starts and http://localhost:3000/admin loads login page
  </verify>
  <done>
    - Users collection with admin/editor roles and RBAC access control
    - Media collection with image upload, auto-resize (thumbnail, card, hero), and alt text
    - Seed script creates first admin user on initial startup
    - payload.config.ts registers both collections and wires seed
    - public/media/ directory exists for local uploads
    - Build succeeds and dev server runs
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Phase 1 success criteria</name>
  <files>N/A (verification only)</files>
  <action>
    Complete Payload CMS backoffice has been built with:
    - Admin authentication (login/logout)
    - User management with admin/editor roles
    - Media library with image upload and auto-resize
    - Existing frontend pages preserved in route group

    **Prerequisites:** Docker must be running (`docker-compose up -d`), dev server must be running (`npm run dev`).

    **Test 1: Admin Login (CMS-01)**
    1. Visit http://localhost:3000/admin
    2. Log in with: email `admin@pleincap.com`, password `Admin123!`
    3. Expected: Dashboard loads showing Users and Media collections in sidebar

    **Test 2: Create Editor Account (CMS-02)**
    1. In admin panel, click "Users" in sidebar under Administration
    2. Click "Create New"
    3. Fill in: email `editeur@pleincap.com`, name `Editeur Test`, role `Editeur`, password `Editor123!`
    4. Click Save
    5. Expected: User created successfully
    6. Log out, then log in as `editeur@pleincap.com` / `Editor123!`
    7. Expected: Editor can access admin panel but cannot see "Create New" button in Users list (restricted)

    **Test 3: Upload Image (CMS-03)**
    1. Log in as editor (or admin)
    2. Click "Media" in sidebar under Contenu
    3. Click "Create New"
    4. Upload any JPG/PNG image, fill in alt text
    5. Click Save
    6. Expected: Image uploaded, thumbnail/card/hero sizes auto-generated, visible in media library

    **Test 4: Existing Pages Unchanged**
    1. Visit http://localhost:3000 (home page)
    2. Visit http://localhost:3000/catalogue
    3. Visit http://localhost:3000/blog
    4. Visit http://localhost:3000/destinations
    5. Expected: All pages load correctly with existing design, no CSS issues, no broken layouts
  </action>
  <verify>User confirms all 4 tests pass by typing "approved" or describes issues found</verify>
  <done>All Phase 1 success criteria verified by human: admin login works, editor creation works with RBAC, media upload works, existing pages unchanged</done>
</task>

</tasks>

<verification>
1. Admin can log into /admin with email `admin@pleincap.com` and password
2. Admin can create a new user with role "editor" and restricted permissions
3. Editor can log in, upload an image, and see it in the media library
4. All existing frontend pages (/, /catalogue, /blog, /destinations, /equipe, etc.) render correctly
5. No CSS bleed between admin panel and frontend pages
6. Database tables were auto-created by Payload in PostgreSQL
</verification>

<success_criteria>
Phase 1 is complete when ALL of the following are true:
- Admin can log into /admin with email and password (CMS-01)
- Admin can create editor accounts with restricted permissions (CMS-02)
- Editor can upload images to media library and see them in backoffice (CMS-03)
- Existing Next.js pages remain unchanged and functional
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
