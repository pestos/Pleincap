---
phase: 04-newsletter-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/payload/collections/Subscribers.ts
  - src/payload/lib/email/emailAdapter.ts
  - src/payload/emails/DoubleOptIn.tsx
  - src/payload/emails/UnsubscribeConfirmation.tsx
  - src/app/api/newsletter/subscribe/route.ts
  - src/app/api/newsletter/confirm/route.ts
  - src/app/api/newsletter/unsubscribe/route.ts
  - payload.config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Visitor can submit their email to subscribe to the newsletter"
    - "Subscriber receives a verification email with a confirmation link (double opt-in)"
    - "Clicking the confirmation link activates the subscription"
    - "Subscriber can unsubscribe in one click from any email without login or confirmation"
    - "Unsubscribe is processed immediately (GDPR compliant)"
    - "Email sending is abstracted behind an adapter interface allowing provider swap"
  artifacts:
    - path: "src/payload/collections/Subscribers.ts"
      provides: "Subscriber collection with email, status, verification token, GDPR audit fields"
      contains: "slug: 'subscribers'"
    - path: "src/payload/lib/email/emailAdapter.ts"
      provides: "Abstract email adapter interface with send/sendBatch methods and console adapter for dev"
      exports: ["EmailAdapter", "getEmailAdapter"]
    - path: "src/app/api/newsletter/subscribe/route.ts"
      provides: "Public POST endpoint for newsletter subscription"
      exports: ["POST"]
    - path: "src/app/api/newsletter/confirm/route.ts"
      provides: "GET endpoint for double opt-in token verification"
      exports: ["GET"]
    - path: "src/app/api/newsletter/unsubscribe/route.ts"
      provides: "GET endpoint for one-click GDPR unsubscribe"
      exports: ["GET"]
    - path: "src/payload/emails/DoubleOptIn.tsx"
      provides: "React Email template for verification email"
    - path: "src/payload/emails/UnsubscribeConfirmation.tsx"
      provides: "React Email template for unsubscribe confirmation"
  key_links:
    - from: "src/app/api/newsletter/subscribe/route.ts"
      to: "payload.create({ collection: 'subscribers' })"
      via: "Payload Local API"
      pattern: "payload\\.create.*subscribers"
    - from: "src/app/api/newsletter/subscribe/route.ts"
      to: "src/payload/lib/email/emailAdapter.ts"
      via: "getEmailAdapter().send() for double opt-in email"
      pattern: "getEmailAdapter|emailAdapter"
    - from: "src/app/api/newsletter/confirm/route.ts"
      to: "payload.find + payload.update on subscribers"
      via: "Token verification and status update"
      pattern: "payload\\.update.*status.*active"
    - from: "src/app/api/newsletter/unsubscribe/route.ts"
      to: "payload.update({ collection: 'subscribers', data: { status: 'unsubscribed' } })"
      via: "Immediate status change"
      pattern: "status.*unsubscribed"
---

<objective>
Create the subscriber management foundation for the newsletter system: Subscribers collection, email service abstraction layer, double opt-in subscription flow, and GDPR-compliant one-click unsubscribe.

Purpose: This is the foundational layer that all other newsletter features (campaigns, analytics, import/export) depend on. The email adapter pattern ensures provider-agnostic architecture per project constraint.
Output: Working subscription/unsubscription flow with Payload collection, API routes, and React Email templates.
</objective>

<execution_context>
@/Users/fredericgueirard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fredericgueirard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-newsletter-foundation/04-RESEARCH.md
@payload.config.ts
@src/payload/collections/Users.ts
@src/payload/collections/Posts.ts
@src/payload/hooks/formatSlug.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, create Subscribers collection and email adapter</name>
  <files>
    package.json
    src/payload/collections/Subscribers.ts
    src/payload/lib/email/emailAdapter.ts
    payload.config.ts
  </files>
  <action>
**Step 1: Install dependencies**
```bash
npm install react-email @react-email/components nanoid
npm install --save-dev @types/nodemailer
```
Note: Do NOT install papaparse yet (that's Plan 03). Do NOT install any email provider SDK yet (provider deferred per project constraint).

**Step 2: Create email adapter abstraction** at `src/payload/lib/email/emailAdapter.ts`

Define the `EmailAdapter` interface with:
- `send(params: { to: string | string[], subject: string, html: string, text?: string, from?: string, replyTo?: string, headers?: Record<string, string> }): Promise<{ success: boolean, messageId?: string, error?: string }>`
- `sendBatch(emails: Array<{ to: string, subject: string, html: string }>): Promise<Array<{ success: boolean, messageId?: string }>>`

Create a `ConsoleEmailAdapter` class implementing the interface that logs emails to console (development/testing). This is the default adapter when no provider is configured.

Create `getEmailAdapter(): EmailAdapter` factory function that:
- Reads `process.env.EMAIL_PROVIDER` (default: 'console')
- Returns `ConsoleEmailAdapter` for 'console' or when no provider configured
- Throws for unsupported providers with helpful message listing available options
- Export the `EMAIL_FROM` constant from `process.env.EMAIL_FROM || 'newsletter@plein-cap.com'`

**Step 3: Create Subscribers collection** at `src/payload/collections/Subscribers.ts`

Follow existing collection patterns (see Posts.ts, Users.ts). Collection config:
- slug: 'subscribers'
- admin: { useAsTitle: 'email', group: 'Newsletter', defaultColumns: ['email', 'status', 'subscribedAt', 'updatedAt'] }
- Fields:
  - `email`: type email, required, unique, index: true
  - `firstName`: type text, optional, label: 'Prenom'
  - `lastName`: type text, optional, label: 'Nom'
  - `status`: type select, required, defaultValue: 'pending', index: true, options: [
      { label: 'En attente', value: 'pending' },
      { label: 'Actif', value: 'active' },
      { label: 'Desabonne', value: 'unsubscribed' },
      { label: 'Rebond', value: 'bounced' }
    ]
  - `verificationToken`: type text, admin: { readOnly: true, hidden: true }
  - `verificationTokenExpiry`: type date, admin: { readOnly: true, hidden: true }
  - `unsubscribeToken`: type text, required: false, admin: { readOnly: true, hidden: true } -- unique per subscriber, used in unsubscribe links
  - `subscribedAt`: type date, admin: { readOnly: true }
  - `unsubscribedAt`: type date, admin: { readOnly: true }
  - `source`: type select, defaultValue: 'website', options: ['website', 'import', 'manual'], admin: { description: "Source de l'inscription" }
  - `ipAddress`: type text, admin: { readOnly: true, hidden: true }
  - `userAgent`: type text, admin: { readOnly: true, hidden: true }
- access: admin-only for all CRUD (read/create/update/delete require `!!req.user`)
- No public read access on this collection (subscriber data is private)

**Step 4: Register Subscribers collection** in `payload.config.ts`
- Import `{ Subscribers }` from './src/payload/collections/Subscribers'
- Add to collections array after Banners

Ensure the build passes after this step.
  </action>
  <verify>
Run `npx next build` (or `npm run build`) and confirm no TypeScript errors. Check that 'subscribers' collection would appear in admin under 'Newsletter' group.
  </verify>
  <done>
Subscribers collection is defined with all required fields (email, status, tokens, audit fields). Email adapter interface exists with console implementation. Dependencies installed. Payload config updated. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create subscription, confirmation, and unsubscribe API routes with React Email templates</name>
  <files>
    src/payload/emails/DoubleOptIn.tsx
    src/payload/emails/UnsubscribeConfirmation.tsx
    src/app/api/newsletter/subscribe/route.ts
    src/app/api/newsletter/confirm/route.ts
    src/app/api/newsletter/unsubscribe/route.ts
  </files>
  <action>
**Step 1: Create React Email templates**

`src/payload/emails/DoubleOptIn.tsx`:
- Use @react-email/components (Html, Head, Body, Container, Section, Text, Link, Preview, Img)
- Props: `{ email: string, confirmUrl: string, baseUrl: string }`
- PleinCap branding: Use inline styles with colors from theme (primary: #C5A059, abyss: #1a2b3c, ecru: #F9F8F6)
- Content in French:
  - Preview: "Confirmez votre inscription a la newsletter PleinCap"
  - Heading: "Confirmez votre inscription"
  - Body text: "Merci de votre interet pour la newsletter PleinCap. Cliquez sur le bouton ci-dessous pour confirmer votre inscription."
  - CTA button: "Confirmer mon inscription" linking to confirmUrl
  - Footer: "Si vous n'avez pas demande cette inscription, ignorez cet email."
  - Expiry note: "Ce lien est valide pendant 24 heures."
- Export a `renderDoubleOptIn(props)` function that uses `render()` from @react-email/render to produce HTML string

`src/payload/emails/UnsubscribeConfirmation.tsx`:
- Similar structure with PleinCap branding
- Props: `{ email: string, baseUrl: string }`
- Content in French:
  - "Desinscription confirmee"
  - "Vous avez ete desinscrit de la newsletter PleinCap. Vous ne recevrez plus nos communications."
  - "Si c'est une erreur, vous pouvez vous reinscrire sur notre site."
  - Link back to newsletter page

**Step 2: Create POST /api/newsletter/subscribe route**

`src/app/api/newsletter/subscribe/route.ts`:
- Validate request body: `{ email: string }` -- use basic validation (check email contains @ and .)
- Use Payload Local API (`getPayload` + config import pattern from existing API routes)
- Check if email already exists in subscribers:
  - If active: return 200 with message "Vous etes deja inscrit"
  - If pending: resend verification email, return 200 "Un email de confirmation a ete envoye"
  - If unsubscribed: reactivate as pending, generate new token, send verification
- Create new subscriber with status 'pending'
- Generate verification token using `nanoid(32)` (import from 'nanoid')
- Generate unsubscribe token using `nanoid(32)` (stored permanently for future unsubscribe links)
- Set verificationTokenExpiry to 24 hours from now
- Capture ipAddress from `request.headers.get('x-forwarded-for')` and userAgent from `request.headers.get('user-agent')`
- Update subscriber with token fields
- Render DoubleOptIn email template
- Send via `getEmailAdapter().send()` with:
  - to: subscriber email
  - subject: "Confirmez votre inscription - PleinCap"
  - html: rendered template
  - headers: { 'List-Unsubscribe': unsubscribe URL } (GDPR requirement)
- Return 200 `{ success: true, message: "Un email de confirmation a ete envoye" }`
- Wrap in try/catch, return 500 on error

**Step 3: Create GET /api/newsletter/confirm route**

`src/app/api/newsletter/confirm/route.ts`:
- Read `token` from URL search params
- If no token: return 400 `{ error: 'Token requis' }`
- Find subscriber where verificationToken equals token AND verificationTokenExpiry > now AND status equals 'pending'
- If not found: return 400 `{ error: 'Token invalide ou expire' }`
- Update subscriber:
  - status: 'active'
  - subscribedAt: new Date().toISOString()
  - verificationToken: null (clear)
  - verificationTokenExpiry: null (clear)
- Redirect to `/news-letter?confirmed=true` (preserve existing newsletter page URL)

**Step 4: Create GET /api/newsletter/unsubscribe route**

`src/app/api/newsletter/unsubscribe/route.ts`:
- Read `token` from URL search params (this is the unsubscribeToken)
- If no token: return 400 `{ error: 'Token requis' }`
- Find subscriber where unsubscribeToken equals token AND status NOT equals 'unsubscribed'
- If not found: return 400 `{ error: 'Lien invalide' }`
- Update subscriber IMMEDIATELY (no confirmation page -- GDPR requirement):
  - status: 'unsubscribed'
  - unsubscribedAt: new Date().toISOString()
- Redirect to `/news-letter?unsubscribed=true`
- Also support POST method for List-Unsubscribe-Post header (RFC 8058): same logic

IMPORTANT: Do NOT add authentication requirement on these routes -- they are public by design (visitors subscribe, subscribers confirm/unsubscribe via email links).
  </action>
  <verify>
Run `npx next build` and confirm no TypeScript errors. Verify all three API routes compile. Check that React Email templates import correctly from @react-email/components.
  </verify>
  <done>
Three public API routes exist: POST /api/newsletter/subscribe (creates pending subscriber, sends verification email), GET /api/newsletter/confirm (activates subscription via token), GET /api/newsletter/unsubscribe (one-click unsubscribe via token). Two React Email templates render PleinCap-branded emails in French. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. Subscribers collection registered in Payload config under 'Newsletter' group
3. API routes exist at /api/newsletter/subscribe, /api/newsletter/confirm, /api/newsletter/unsubscribe
4. Email adapter interface exported with ConsoleEmailAdapter for development
5. React Email templates render valid HTML
</verification>

<success_criteria>
- Subscribers collection exists with email, status, verification tokens, unsubscribe token, and GDPR audit fields
- Email adapter abstraction allows future provider swap without changing business logic
- Double opt-in flow: subscribe -> pending -> verify token -> active
- One-click unsubscribe: click link -> immediately unsubscribed (no confirmation step)
- All API routes are public (no auth required) since they serve end-user flows
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/04-newsletter-foundation/04-01-SUMMARY.md`
</output>
