---
phase: 04-newsletter-foundation
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/app/(frontend)/news-letter/page.tsx
autonomous: false

must_haves:
  truths:
    - "Newsletter subscription form on the frontend connects to the subscribe API"
    - "User sees confirmation/error messages after subscribing"
    - "User sees confirmation message after email verification (redirected from confirm route)"
    - "User sees unsubscription message (redirected from unsubscribe route)"
    - "All newsletter collections appear in Payload admin under Newsletter group"
    - "Full build passes with all Phase 4 collections and routes"
  artifacts:
    - path: "src/app/(frontend)/news-letter/page.tsx"
      provides: "Newsletter page with working subscription form connected to API"
  key_links:
    - from: "src/app/(frontend)/news-letter/page.tsx"
      to: "/api/newsletter/subscribe"
      via: "fetch POST on form submit"
      pattern: "api/newsletter/subscribe"
---

<objective>
Wire the existing newsletter page subscription form to the backend API, add user feedback for subscription/confirmation/unsubscription states, and perform full integration verification.

Purpose: Connects the frontend to the backend, completing the end-to-end newsletter flow. The verification checkpoint ensures all Phase 4 components work together before proceeding to Phase 5.
Output: Working frontend subscription form and verified newsletter system.
</objective>

<execution_context>
@/Users/fredericgueirard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fredericgueirard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-newsletter-foundation/04-01-SUMMARY.md
@.planning/phases/04-newsletter-foundation/04-02-SUMMARY.md
@.planning/phases/04-newsletter-foundation/04-03-SUMMARY.md
@src/app/(frontend)/news-letter/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire newsletter subscription form to API and add status feedback</name>
  <files>
    src/app/(frontend)/news-letter/page.tsx
  </files>
  <action>
Update the existing newsletter page at `src/app/(frontend)/news-letter/page.tsx` to connect the subscription form to the backend API.

**Changes to make:**

1. **Add form state management** (page already uses 'use client' and useState):
   - Add `email` state for the input value
   - Add `isSubmitting` state (boolean) for loading state
   - Add `message` state: `{ type: 'success' | 'error', text: string } | null`

2. **Add form submit handler:**
   ```typescript
   const handleSubscribe = async (e: React.FormEvent) => {
     e.preventDefault()
     setIsSubmitting(true)
     setMessage(null)

     try {
       const res = await fetch('/api/newsletter/subscribe', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ email }),
       })
       const data = await res.json()

       if (res.ok) {
         setMessage({ type: 'success', text: data.message })
         setEmail('')
       } else {
         setMessage({ type: 'error', text: data.error || 'Une erreur est survenue' })
       }
     } catch {
       setMessage({ type: 'error', text: 'Erreur de connexion. Veuillez reessayer.' })
     } finally {
       setIsSubmitting(false)
     }
   }
   ```

3. **Update the subscription form section** (the dark `bg-abyss` section near the bottom of the page):
   - Add `onSubmit={handleSubscribe}` to the form element
   - Bind input value to `email` state, add `onChange`
   - Disable submit button when `isSubmitting` (show "Envoi en cours..." text)
   - Display message below the form:
     - Success: green text (text-green-400 on dark bg)
     - Error: red text (text-red-400 on dark bg)
   - Keep the existing styling intact -- only add functionality

4. **Handle URL query params for confirmation/unsubscription feedback:**
   - Read `confirmed` and `unsubscribed` from URL search params (useSearchParams from next/navigation)
   - If `confirmed=true`: show a banner at top of page "Inscription confirmee ! Bienvenue dans la communaute PleinCap." with success styling
   - If `unsubscribed=true`: show a banner "Desinscription confirmee. Vous ne recevrez plus nos communications."
   - Use the PleinCap design language (primary gold color, uppercase tracking, sharp edges)
   - Add Suspense boundary around the component that uses useSearchParams (Next.js requirement)

5. **Preserve all existing content and styling** -- the newsletter archives section, featured edition, filtering, benefits section should remain unchanged. Only modify the subscription form section and add the status banners.
  </action>
  <verify>
Run `npm run build` and confirm no TypeScript errors. Verify:
1. Newsletter page compiles with new form logic
2. Form submit calls /api/newsletter/subscribe
3. Success/error messages display correctly
4. URL params ?confirmed=true and ?unsubscribed=true show banners
  </verify>
  <done>
Newsletter page subscription form is connected to the API. Users see feedback after subscribing (success/error). Confirmation and unsubscription redirects show appropriate banners. All existing page content and styling preserved. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Full Phase 4 integration verification</name>
  <files>
    src/app/(frontend)/news-letter/page.tsx
  </files>
  <action>
Human verification checkpoint. Present the verification steps below to the user and wait for approval.

Complete newsletter system built across Plans 01-04:
- Subscribers collection (Payload admin > Newsletter)
- Campaigns collection with campaign creation and sending
- CampaignSends tracking collection
- EmailAnalytics collection for open/click tracking
- Email service abstraction layer (console adapter for dev)
- Double opt-in subscription flow (subscribe -> verify -> active)
- One-click GDPR unsubscribe
- CSV import/export for subscriber management
- Email tracking (pixel for opens, redirect for clicks)
- Frontend subscription form connected to API

Verification steps:

1. Verify Payload Admin Collections:
   - Start dev server: `npm run dev`
   - Go to http://localhost:3000/admin
   - Verify 'Newsletter' group in sidebar contains: Subscribers, Campaigns, Campaign Sends, Email Analytics

2. Test Subscription Flow:
   - Go to http://localhost:3000/news-letter
   - Enter an email in the subscription form and submit
   - Verify success message appears
   - Check terminal/console for the verification email logged by ConsoleEmailAdapter
   - Check Payload admin > Subscribers: new subscriber with status 'pending'
   - Copy the confirmation URL from the console log
   - Visit the confirmation URL in browser
   - Verify redirect to /news-letter?confirmed=true with success banner
   - Check Payload admin > Subscribers: status changed to 'active'

3. Test Unsubscribe Flow:
   - In Payload admin > Subscribers, find the subscriber's unsubscribeToken
   - Visit http://localhost:3000/api/newsletter/unsubscribe?token={unsubscribeToken}
   - Verify redirect to /news-letter?unsubscribed=true with unsubscription banner
   - Check Payload admin > Subscribers: status changed to 'unsubscribed'

4. Test Campaign Creation:
   - Go to Payload admin > Campaigns
   - Create a new campaign with name, subject, content
   - Verify tabs layout (Contenu/Envoi/Statistiques)
   - Save as draft -- verify it does NOT trigger sending

5. Verify CSV Export:
   - Visit http://localhost:3000/api/admin/subscribers/export (while logged into admin)
   - Verify CSV file downloads with subscriber data

6. Verify Build:
   - Run `npm run build` -- should complete without errors

NOTE: DNS authentication (SPF, DKIM, DMARC) is NOT tested here -- it is a Phase 5 concern when a real email provider is configured. The console adapter is sufficient for Phase 4 verification.
  </action>
  <verify>
User confirms all verification steps pass by typing "approved".
  </verify>
  <done>
All Phase 4 newsletter features verified by human: subscription flow, unsubscribe flow, campaign creation, CSV export, admin collections visible, build passes.
  </done>
</task>

</tasks>

<verification>
1. Frontend subscription form connects to backend API
2. Double opt-in flow works end-to-end (subscribe -> verify email -> active)
3. One-click unsubscribe works (click link -> immediately unsubscribed)
4. All 4 newsletter collections visible in Payload admin
5. Campaign creation works with tabs layout
6. CSV export returns valid file
7. `npm run build` passes
</verification>

<success_criteria>
- Newsletter subscription form works on the frontend
- Full double opt-in flow verified manually
- One-click unsubscribe verified manually
- All newsletter collections accessible in Payload admin
- Campaign creation and draft saving work
- CSV export works
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-newsletter-foundation/04-04-SUMMARY.md`
</output>
