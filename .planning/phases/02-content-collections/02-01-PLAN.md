---
phase: 02-content-collections
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/payload/hooks/formatSlug.ts
  - src/payload/collections/Speakers.ts
  - src/payload/collections/Team.ts
  - src/payload/collections/Testimonials.ts
  - payload.config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "formatSlug hook generates URL-safe slugs from French text with accents"
    - "SEO plugin is installed and available for collection configuration"
    - "Editor can create/edit/delete speakers with name, photo, specialty, and bio"
    - "Editor can create/edit/delete team members with name, photo, role, and bio"
    - "Editor can create/edit/delete testimonials with author, content, and rating"
    - "Admin sidebar groups new collections under 'Contenu'"
  artifacts:
    - path: "src/payload/hooks/formatSlug.ts"
      provides: "Reusable slug auto-generation field hook"
      exports: ["formatSlug"]
    - path: "src/payload/collections/Speakers.ts"
      provides: "Speakers collection with name, slug, photo, specialty, bio"
      exports: ["Speakers"]
    - path: "src/payload/collections/Team.ts"
      provides: "Team members collection with name, slug, photo, role, bio"
      exports: ["Team"]
    - path: "src/payload/collections/Testimonials.ts"
      provides: "Testimonials collection with author, content, rating, cruise reference"
      exports: ["Testimonials"]
  key_links:
    - from: "payload.config.ts"
      to: "src/payload/collections/Speakers.ts"
      via: "import and collections array registration"
      pattern: "import.*Speakers.*collections.*Speakers"
    - from: "payload.config.ts"
      to: "src/payload/collections/Team.ts"
      via: "import and collections array registration"
      pattern: "import.*Team.*collections.*Team"
    - from: "payload.config.ts"
      to: "src/payload/collections/Testimonials.ts"
      via: "import and collections array registration"
      pattern: "import.*Testimonials.*collections.*Testimonials"
    - from: "src/payload/collections/Speakers.ts"
      to: "src/payload/hooks/formatSlug.ts"
      via: "field hook import for slug field"
      pattern: "import.*formatSlug.*hooks/formatSlug"
---

<objective>
Create shared utility (formatSlug hook), install SEO plugin, and build three simple content collections (Speakers, Team, Testimonials) that establish the pattern for all Phase 2 collections.

Purpose: Establish reusable patterns (slug generation, access control, admin grouping) and deliver the first content collections editors can use immediately.
Output: 3 working collections in Payload admin, formatSlug utility, SEO plugin installed.
</objective>

<execution_context>
@/Users/fredericgueirard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fredericgueirard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-collections/02-RESEARCH.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@payload.config.ts
@src/payload/collections/Users.ts
@src/payload/collections/Media.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create formatSlug hook and install SEO plugin</name>
  <files>
    src/payload/hooks/formatSlug.ts
    package.json
  </files>
  <action>
1. Create `src/payload/hooks/formatSlug.ts` with a reusable field hook:
   - Export a `formatSlug` function that takes a `fallback` field name (e.g., 'name', 'title') and returns a Payload `FieldHook`
   - On `create` operation OR when slug value is empty: auto-generate from the fallback field
   - Slug generation: lowercase, NFD normalize to decompose accents, strip accent marks ([\u0300-\u036f]), replace non-alphanumeric with hyphens, trim leading/trailing hyphens
   - On `update` with existing value: preserve the existing slug (don't overwrite manual edits)
   - Type import: `import type { FieldHook } from 'payload'`

2. Install `@payloadcms/plugin-seo` (same version as payload, 3.76.1):
   ```bash
   npm install @payloadcms/plugin-seo
   ```
   Do NOT configure the plugin in payload.config.ts yet -- that will happen in Plan 04 when all public-facing collections exist.
  </action>
  <verify>
- File `src/payload/hooks/formatSlug.ts` exists and exports `formatSlug`
- `npm ls @payloadcms/plugin-seo` shows the package is installed
- TypeScript compiles: `npx tsc --noEmit` passes (or at least no errors in new files)
  </verify>
  <done>formatSlug hook ready for import by all collections. SEO plugin installed and available.</done>
</task>

<task type="auto">
  <name>Task 2: Create Speakers, Team, and Testimonials collections</name>
  <files>
    src/payload/collections/Speakers.ts
    src/payload/collections/Team.ts
    src/payload/collections/Testimonials.ts
    payload.config.ts
  </files>
  <action>
Create three collections following the established RBAC pattern from Phase 1 (Users.ts, Media.ts).

**Speakers collection** (`src/payload/collections/Speakers.ts`):
- slug: 'speakers'
- admin.useAsTitle: 'name', admin.group: 'Contenu', admin.defaultColumns: ['name', 'specialty', 'updatedAt']
- Fields:
  - `name`: text, required, label 'Nom complet'
  - `slug`: text, required, unique, index: true, hooks.beforeValidate: [formatSlug('name')], admin.description: 'Identifiant URL (auto-generé depuis le nom)'
  - `photo`: upload, relationTo: 'media', required, label 'Photo'
  - `specialty`: text, required, label 'Spécialité', admin.placeholder: 'ex: Archéologie, Histoire, Biologie marine'
  - `bio`: richText, required, label 'Biographie'
  - `website`: text, label 'Site web', admin.placeholder: 'https://...'
- Access: read () => true (public), create/update ({ req: { user } }) => !!user, delete ({ req: { user } }) => user?.role === 'admin'

**Team collection** (`src/payload/collections/Team.ts`):
- slug: 'team'
- admin.useAsTitle: 'name', admin.group: 'Contenu', admin.defaultColumns: ['name', 'role', 'updatedAt']
- Fields:
  - `name`: text, required, label 'Nom complet'
  - `slug`: text, required, unique, index: true, hooks.beforeValidate: [formatSlug('name')]
  - `photo`: upload, relationTo: 'media', required, label 'Photo'
  - `jobTitle`: text, required, label 'Poste / Fonction', admin.placeholder: 'ex: Directrice commerciale'
  - `bio`: richText, label 'Biographie'
  - `email`: text, label 'Email de contact'
  - `order`: number, label 'Ordre d\'affichage', defaultValue: 0, admin.description: 'Ordre d\'affichage sur la page équipe (0 = premier)'
- Access: same pattern as Speakers (public read, authenticated create/update, admin-only delete)

**Testimonials collection** (`src/payload/collections/Testimonials.ts`):
- slug: 'testimonials'
- admin.useAsTitle: 'authorName', admin.group: 'Contenu', admin.defaultColumns: ['authorName', 'rating', 'updatedAt']
- Fields:
  - `authorName`: text, required, label 'Nom du client'
  - `authorPhoto`: upload, relationTo: 'media', label 'Photo du client'
  - `content`: textarea, required, label 'Témoignage', admin.rows: 5
  - `rating`: number, required, label 'Note (1-5)', min: 1, max: 5, defaultValue: 5
  - `cruiseName`: text, label 'Nom de la croisière', admin.description: 'Nom de la croisière concernée (texte libre)'
  - `date`: date, label 'Date du témoignage', admin.date.pickerAppearance: 'dayOnly'
  - `featured`: checkbox, label 'Mis en avant', defaultValue: false, admin.description: 'Affiché sur la page d\'accueil'
- Access: same pattern (public read, authenticated create/update, admin-only delete)

**Register in payload.config.ts:**
- Import all three collections from src/payload/collections/
- Add to collections array: [Users, Media, Speakers, Team, Testimonials]
- Do NOT change any existing config (editor, db, sharp, onInit, etc.)
  </action>
  <verify>
- `npm run build` completes without errors
- All three collection files exist and export CollectionConfig
- payload.config.ts imports and registers all three collections
- Start dev server (`npm run dev`) and verify collections appear in /admin sidebar under 'Contenu' group
  </verify>
  <done>Speakers, Team, and Testimonials collections are visible in the Payload admin panel. Editors can create/edit/delete items in each. Slugs auto-generate from names. Admin sidebar shows collections grouped under 'Contenu'.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. Navigate to /admin -- three new collections (Speakers, Team, Testimonials) appear under 'Contenu' group
3. Create a speaker with accented name (e.g., "René Dupré") -- slug auto-generates as "rene-dupre"
4. Create a team member -- verify photo upload works via Media relationship
5. Create a testimonial with rating 4 -- verify it saves and displays correctly
6. Verify access control: editor can create but not delete, admin can delete
</verification>

<success_criteria>
- formatSlug hook generates correct slugs from French text with accents
- @payloadcms/plugin-seo is installed (visible in package.json)
- Speakers, Team, Testimonials collections functional in admin with CRUD operations
- All collections grouped under 'Contenu' in admin sidebar
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-collections/02-01-SUMMARY.md`
</output>
