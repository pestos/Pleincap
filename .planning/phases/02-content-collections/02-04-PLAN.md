---
phase: 02-content-collections
plan: 04
type: execute
wave: 4
depends_on: ["02-01", "02-02", "02-03"]
files_modified:
  - src/payload/collections/Cruises.ts
  - payload.config.ts
autonomous: false

must_haves:
  truths:
    - "Editor can create/edit/delete cruises with title, dates, price, and available spots"
    - "Editor can link a cruise to a destination, a boat, and multiple speakers via relationship fields"
    - "Editor can build a day-by-day itinerary with day number, title, description, highlights, and photos"
    - "Editor can save cruise as draft and publish when ready"
    - "Editor can edit SEO meta tags (title, description, image) on cruises, posts, destinations, and boats"
    - "Editor can bulk update prices or dates across multiple cruises using admin list view"
    - "All 11 collections (+ Users + Media = 13 total) appear properly grouped in admin sidebar"
  artifacts:
    - path: "src/payload/collections/Cruises.ts"
      provides: "Cruises collection with relationships, itinerary array, drafts, tabs"
      exports: ["Cruises"]
  key_links:
    - from: "src/payload/collections/Cruises.ts"
      to: "src/payload/collections/Destinations.ts"
      via: "relationship field"
      pattern: "relationTo.*destinations"
    - from: "src/payload/collections/Cruises.ts"
      to: "src/payload/collections/Boats.ts"
      via: "relationship field"
      pattern: "relationTo.*boats"
    - from: "src/payload/collections/Cruises.ts"
      to: "src/payload/collections/Speakers.ts"
      via: "relationship field (hasMany)"
      pattern: "relationTo.*speakers"
    - from: "payload.config.ts"
      to: "@payloadcms/plugin-seo"
      via: "plugin configuration in plugins array"
      pattern: "seoPlugin.*collections.*cruises.*posts"
    - from: "payload.config.ts"
      to: "src/payload/collections/Cruises.ts"
      via: "import and collections array registration"
      pattern: "import.*Cruises"
---

<objective>
Create the Cruises collection (the most complex collection with relationships, itinerary array, and drafts), configure the SEO plugin for all public-facing collections, and verify the complete Phase 2 setup.

Purpose: Complete all content collections and cross-cutting features (SEO, drafts, bulk ops). This is the capstone plan that ties everything together.
Output: Cruises collection working with all relationships. SEO plugin active. All Phase 2 success criteria met.
</objective>

<execution_context>
@/Users/fredericgueirard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fredericgueirard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-collections/02-RESEARCH.md
@.planning/phases/02-content-collections/02-01-SUMMARY.md
@.planning/phases/02-content-collections/02-02-SUMMARY.md
@.planning/phases/02-content-collections/02-03-SUMMARY.md
@payload.config.ts
@src/payload/collections/Destinations.ts
@src/payload/collections/Boats.ts
@src/payload/collections/Speakers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cruises collection and configure SEO plugin</name>
  <files>
    src/payload/collections/Cruises.ts
    payload.config.ts
  </files>
  <action>
**Cruises collection** (`src/payload/collections/Cruises.ts`):
- slug: 'cruises'
- admin.useAsTitle: 'title', admin.group: 'Croisieres', admin.defaultColumns: ['title', 'destination', 'departureDate', '_status', 'updatedAt']
- admin.description: 'Gestion des croisières avec itinéraires et relations'
- versions.drafts with autosave (interval: 375), maxPerDoc: 50
- Fields using **tabs layout** for organized editing:

**Tab "Contenu":**
  - `title`: text, required, label 'Titre de la croisière'
  - `slug`: text, required, unique, index: true, hooks.beforeValidate: [formatSlug('title')]
  - `excerpt`: textarea, required, label 'Résumé court', admin.description: 'Utilisé pour les vignettes et le SEO'
  - `description`: richText, required, label 'Description complète'
  - `featuredImage`: upload, relationTo: 'media', required, label 'Image mise en avant'

**Tab "Détails":**
  - `destination`: relationship, relationTo: 'destinations', required, label 'Destination'
  - `boat`: relationship, relationTo: 'boats', required, label 'Bateau'
  - `speakers`: relationship, relationTo: 'speakers', hasMany: true, label 'Conférenciers', admin.description: 'Glisser-déposer pour réorganiser'
  - Row field with `departureDate` (date, required, label 'Date de départ', pickerAppearance: 'dayOnly', width: '50%') and `returnDate` (date, required, label 'Date de retour', pickerAppearance: 'dayOnly', width: '50%')
  - Row field with `price` (number, required, label 'Prix à partir de (€)', min: 0, width: '50%') and `availableSpots` (number, required, label 'Places disponibles', min: 0, defaultValue: 0, width: '50%')
  - `flightIncluded`: checkbox, label 'Vol inclus', defaultValue: false
  - `rating`: number, label 'Note moyenne', min: 0, max: 5, admin.step: 0.1

**Tab "Itinéraire":**
  - `itinerary`: array, label 'Jours', minRows: 1, admin.description: 'Programme jour par jour de la croisière', fields: [
      Row field with:
        - `day`: number, required, label 'Jour', width: '20%'
        - `title`: text, required, label 'Titre', width: '80%', admin.placeholder: 'ex: Athènes - Embarquement'
      `description`: richText, required, label 'Programme'
      `highlights`: textarea, label 'Points forts', admin.description: 'Un point fort par ligne (optionnel)', admin.rows: 3
      `images`: upload, relationTo: 'media', hasMany: true, label 'Photos du jour'
    ]

- Access:
  - read: If user, return true. If public, return { _status: { equals: 'published' } }
  - create: ({ req: { user } }) => !!user
  - update: ({ req: { user } }) => !!user
  - delete: ({ req: { user } }) => user?.role === 'admin'

**Configure SEO plugin in payload.config.ts:**
- Import `seoPlugin` from `@payloadcms/plugin-seo`
- Add `plugins` array to buildConfig (after `collections`):
  ```typescript
  plugins: [
    seoPlugin({
      collections: ['cruises', 'posts', 'destinations', 'boats'],
      tabbedUI: true,
      uploadsCollection: 'media',
      generateTitle: ({ doc }) => `${doc.title || doc.name} | PleinCap Croisières`,
      generateDescription: ({ doc }) => {
        const text = doc.excerpt || ''
        return typeof text === 'string' ? text.substring(0, 160) : ''
      },
      generateURL: ({ doc }) => `https://plein-cap.com/${doc.slug || ''}`,
    }),
  ],
  ```
- Import Cruises and add to collections array
- Ensure collections array order is: Users, Media, Cruises, Destinations, Boats, Speakers, Team, Posts, Categories, Tags, Testimonials, Banners
  (This puts high-traffic collections first in config, and organizes by admin group)
  </action>
  <verify>
- `npm run build` completes without errors
- Cruises.ts exports CollectionConfig with relationship fields to destinations, boats, speakers
- Cruises.ts has itinerary array with day/title/description/highlights/images sub-fields
- payload.config.ts has seoPlugin configured with collections array
- payload.config.ts has Cruises in collections array
- Navigate to /admin -- Cruises appears under 'Croisieres' group with SEO tab
  </verify>
  <done>Cruises collection created with all relationships, itinerary array, drafts, and tab layout. SEO plugin configured for cruises, posts, destinations, and boats.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 2 setup</name>
  <files>payload.config.ts</files>
  <action>
Human verification of all Phase 2 collections and features.

What was built: Complete content collection system with 11 new collections (13 total including Users and Media from Phase 1):

**Croisieres group:** Cruises (with itinerary, relationships, drafts, SEO), Destinations (with SEO), Boats (with cabin array, SEO)
**Blog group:** Posts (with categories, tags, author, drafts, SEO), Categories, Tags
**Contenu group:** Speakers, Team, Testimonials, Media
**Configuration group:** Banners (with image/video hero blocks, drafts)
**Administration group:** Users

Cross-cutting features:
- SEO meta tags on Cruises, Posts, Destinations, Boats
- Draft/publish workflow on Cruises, Posts, Banners
- Bulk operations available via admin list view (select all, bulk edit/delete/publish)
- Auto-generated slugs from titles/names on all public collections

How to verify -- Start dev server: `npm run dev`, navigate to http://localhost:3000/admin

**Test 1 - Admin sidebar organization:**
- Verify groups: Croisieres (Cruises, Destinations, Boats), Blog (Posts, Categories, Tags), Contenu (Speakers, Team, Testimonials, Media), Configuration (Banners), Administration (Users)

**Test 2 - Cruises with relationships (CONT-01, CONT-09, CONT-10):**
1. First create a destination (e.g., "Grece et Turquie")
2. Create a boat (e.g., "Amadeus Diamond") with at least 1 cabin type
3. Create a speaker (e.g., "Jean Dupont")
4. Create a cruise: link to the destination, boat, and speaker
5. Add 2 itinerary days with titles and descriptions
6. Save as draft, then publish
7. Verify SEO tab appears with auto-generated title

**Test 3 - Blog system (CONT-06):**
1. Create a category "Destinations"
2. Create a tag "Mediterranee"
3. Create a blog post, assign the category and tag
4. Verify author auto-defaults to your user
5. Save as draft, then publish

**Test 4 - Banners (CONT-08):**
1. Create a banner for "Page d'accueil"
2. Select "Hero avec image" block type
3. Fill in title, subtitle, CTA text and link
4. Save as draft, then publish

**Test 5 - Bulk operations (CMS-05):**
1. Go to Cruises list view
2. Select multiple items (if you created more than one)
3. Verify bulk action buttons appear (Edit, Delete, Publish/Unpublish)

**Test 6 - Frontend unaffected:**
1. Navigate to http://localhost:3000 (home page)
2. Verify existing pages still work correctly

Type "approved" if all tests pass, or describe any issues found.
  </action>
  <verify>User confirms all 6 tests pass by typing "approved"</verify>
  <done>All Phase 2 success criteria verified by human. All 13 collections functional in admin panel.</done>
</task>

</tasks>

<verification>
Phase 2 success criteria from ROADMAP.md:
1. Editor can create/edit/delete cruises with itineraries and day-by-day highlights -- verified via Cruises collection
2. Editor can create/edit/delete destinations, boats with cabin specs, speakers, and team members -- verified via respective collections
3. Editor can create/edit/delete blog articles with categories and tags -- verified via Posts/Categories/Tags
4. Editor can create/edit/delete testimonials and banner/hero sections -- verified via Testimonials/Banners
5. Editor can link cruises to boats, destinations, and speakers through relationships -- verified via Cruises relationship fields
6. Editor can save drafts, preview content before publishing, and edit SEO meta tags -- verified via drafts config + SEO plugin
7. Editor can bulk update prices or dates across multiple cruises at once -- verified via Payload admin bulk operations
</verification>

<success_criteria>
- Cruises collection fully functional with destination/boat/speaker relationships and itinerary array
- SEO plugin adds meta.title, meta.description, meta.image to cruises, posts, destinations, boats
- Draft/publish workflow works on cruises, posts, banners
- All 7 Phase 2 success criteria from ROADMAP.md are met
- Build passes cleanly
- Existing frontend pages remain unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-collections/02-04-SUMMARY.md`
</output>
