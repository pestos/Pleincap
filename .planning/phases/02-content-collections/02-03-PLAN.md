---
phase: 02-content-collections
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/payload/collections/Posts.ts
  - src/payload/collections/Banners.ts
  - payload.config.ts
autonomous: true

must_haves:
  truths:
    - "Editor can create/edit/delete blog posts with title, rich text content, featured image, and excerpt"
    - "Editor can assign multiple categories and tags to a blog post"
    - "Blog post author auto-defaults to current user"
    - "Editor can create/edit/delete banners with image hero or video hero content blocks"
    - "Banner location select restricts placement to predefined site sections"
    - "Admin sidebar groups Posts under 'Blog' and Banners under 'Configuration'"
  artifacts:
    - path: "src/payload/collections/Posts.ts"
      provides: "Blog posts collection with categories, tags, author relationships"
      exports: ["Posts"]
    - path: "src/payload/collections/Banners.ts"
      provides: "Banners collection with blocks field for image/video hero types"
      exports: ["Banners"]
  key_links:
    - from: "src/payload/collections/Posts.ts"
      to: "src/payload/collections/Categories.ts"
      via: "relationship field (hasMany)"
      pattern: "relationTo.*categories"
    - from: "src/payload/collections/Posts.ts"
      to: "src/payload/collections/Tags.ts"
      via: "relationship field (hasMany)"
      pattern: "relationTo.*tags"
    - from: "src/payload/collections/Posts.ts"
      to: "src/payload/collections/Users.ts"
      via: "relationship field (author)"
      pattern: "relationTo.*users"
    - from: "payload.config.ts"
      to: "src/payload/collections/Posts.ts"
      via: "import and collections array registration"
      pattern: "import.*Posts"
    - from: "payload.config.ts"
      to: "src/payload/collections/Banners.ts"
      via: "import and collections array registration"
      pattern: "import.*Banners"
---

<objective>
Create Blog Posts collection (with category/tag/author relationships) and Banners collection (with blocks field for flexible hero sections).

Purpose: Complete the blog system by adding Posts that reference Categories and Tags from Plan 02. Add Banners with blocks field to demonstrate flexible content editing for hero sections.
Output: 2 working collections registered in Payload admin.
</objective>

<execution_context>
@/Users/fredericgueirard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fredericgueirard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-collections/02-RESEARCH.md
@.planning/phases/02-content-collections/02-02-SUMMARY.md
@payload.config.ts
@src/payload/hooks/formatSlug.ts
@src/payload/collections/Categories.ts
@src/payload/collections/Tags.ts
@src/payload/collections/Users.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Posts collection with blog relationships</name>
  <files>
    src/payload/collections/Posts.ts
  </files>
  <action>
Create **Posts collection** (`src/payload/collections/Posts.ts`):
- slug: 'posts'
- admin.useAsTitle: 'title', admin.group: 'Blog', admin.defaultColumns: ['title', 'author', 'publishedDate', '_status', 'updatedAt']
- versions.drafts with autosave (interval: 375) -- blog posts need draft/publish workflow
- Fields using tabs layout for organized editing:

**Tab "Contenu":**
  - `title`: text, required, label 'Titre de l\'article'
  - `slug`: text, required, unique, index: true, hooks.beforeValidate: [formatSlug('title')]
  - `excerpt`: textarea, required, label 'Résumé', admin.description: 'Affiché dans les listes et utilisé pour le SEO', admin.rows: 3
  - `content`: richText, required, label 'Contenu de l\'article'
  - `featuredImage`: upload, relationTo: 'media', required, label 'Image mise en avant'

**Tab "Taxonomie":**
  - `categories`: relationship, relationTo: 'categories', hasMany: true, label 'Catégories'
  - `tags`: relationship, relationTo: 'tags', hasMany: true, label 'Tags'

**Tab "Publication":**
  - `author`: relationship, relationTo: 'users', required, label 'Auteur', defaultValue: ({ user }) => user?.id (auto-set to current user)
  - `publishedDate`: date, required, label 'Date de publication', admin.date.pickerAppearance: 'dayOnly', defaultValue: () => new Date().toISOString()

- Access:
  - read: If authenticated user, return true. If public (no user), return { _status: { equals: 'published' } } -- public only sees published posts
  - create: ({ req: { user } }) => !!user
  - update: ({ req: { user } }) => !!user
  - delete: ({ req: { user } }) => user?.role === 'admin'
  </action>
  <verify>
- File exists and exports Posts CollectionConfig
- Has relationship fields pointing to 'categories', 'tags', 'users'
- Has versions.drafts configuration with autosave
- TypeScript compiles
  </verify>
  <done>Posts collection created with category/tag relationships, author auto-default, draft/publish workflow, and tab-based editing layout.</done>
</task>

<task type="auto">
  <name>Task 2: Create Banners collection with blocks field, register both in config</name>
  <files>
    src/payload/collections/Banners.ts
    payload.config.ts
  </files>
  <action>
Create **Banners collection** (`src/payload/collections/Banners.ts`):
- slug: 'banners'
- admin.useAsTitle: 'name', admin.group: 'Configuration', admin.defaultColumns: ['name', 'location', 'updatedAt']
- versions.drafts with autosave (interval: 375) -- banners need review before publishing
- Fields:
  - `name`: text, required, label 'Nom interne', admin.description: 'Pour identifier le banner dans le backoffice'
  - `location`: select, required, label 'Emplacement', options: [
      { label: 'Page d\'accueil', value: 'home' },
      { label: 'Page Croisières', value: 'cruises' },
      { label: 'Page Destinations', value: 'destinations' },
      { label: 'Page Blog', value: 'blog' },
      { label: 'Page Contact', value: 'contact' }
    ]
  - `content`: blocks, label: 'Contenu', minRows: 1, maxRows: 1, blocks: [
      **Block 'imageHero':**
        labels: { singular: 'Hero avec image', plural: 'Heroes avec image' }
        fields:
          - `image`: upload, relationTo: 'media', required, label 'Image de fond'
          - `title`: text, required, label 'Titre'
          - `subtitle`: text, label 'Sous-titre'
          - `ctaText`: text, label 'Texte du bouton'
          - `ctaLink`: text, label 'Lien du bouton'

      **Block 'videoHero':**
        labels: { singular: 'Hero avec vidéo', plural: 'Heroes avec vidéo' }
        fields:
          - `videoUrl`: text, required, label 'URL vidéo YouTube/Vimeo'
          - `title`: text, required, label 'Titre'
          - `subtitle`: text, label 'Sous-titre'
          - `overlay`: checkbox, label 'Afficher overlay sombre', defaultValue: true
    ]

- Access:
  - read: If user, return true. If public, return { _status: { equals: 'published' } }
  - create: ({ req: { user } }) => !!user
  - update: ({ req: { user } }) => !!user
  - delete: ({ req: { user } }) => user?.role === 'admin'

**Register in payload.config.ts:**
- Import Posts and Banners from src/payload/collections/
- Add to existing collections array (after all collections from Plans 01 and 02)
- Keep existing config unchanged
  </action>
  <verify>
- `npm run build` completes without errors
- payload.config.ts has Posts and Banners imported and registered
- Navigate to /admin -- Posts visible under 'Blog' group, Banners under 'Configuration' group
- Create a blog post and assign it to a category -- verify relationship works
- Create a banner with imageHero block -- verify blocks field renders
  </verify>
  <done>Posts and Banners collections registered and functional. Posts support draft/publish, categories, tags, and author. Banners support image hero and video hero block types.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. Navigate to /admin -- Posts under 'Blog', Banners under 'Configuration'
3. Create a blog post: assign categories and tags, verify author auto-defaults to current user
4. Save blog post as draft -- verify 'Save Draft' button works, _status shows 'draft'
5. Publish blog post -- verify 'Publish' button works
6. Create a banner with image hero for 'home' location -- verify blocks field with image upload
7. Create a banner with video hero -- verify video URL and overlay checkbox work
</verification>

<success_criteria>
- Posts collection supports rich text, categories, tags, author, draft/publish
- Banners collection supports imageHero and videoHero block types
- Blog post author auto-defaults to current logged-in user
- Draft/publish workflow works on both Posts and Banners
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-collections/02-03-SUMMARY.md`
</output>
